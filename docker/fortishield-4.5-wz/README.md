# Fortishield Stack 4.5.x

On this folder, we can find two types of environments:

- release environment, managed by the `rel.sh` script
- prerelease environment managed by the `pre.sh` script

### UI Credentials

The default user and password to access the UI at https://0.0.0.0:5601/ are:

```
admin:SecretPassword
```

## Release environment

This environment will start a working deployment with:

- Fortishield Manager
- Fortishield Indexer
- Fortishield Dashboard

Check the scripts for a list of the supported Fortishield versions.

The environment expect the network `mon` to exists, either bring up the
`mon` stack or execute the following command:

```bash
docker network create mon
```

The images used here are generated by the CI/CD team and uploaded into
the official Docker Hub organization. No Fortishield Agent image is provided yet,
so you'll need to deploy an agent in Docker manually, by following the
instructions below.

### Image certificates

Certificates are created automatically by the docker-compose, but if
it fails to create them with the appropriate permissions, we might need
to adjust them.

This is related to the way the official Fortishield docker images are
prepared.

### Registering agents using Docker

To register an agent, we need to get the enrollment command from the
UI and then execute:

- For `CentOS/8` images:

  ```bash
  docker run --name wz-rel-agent-4.5.0 --rm --network wz-rel-450 --label com.docker.compose.project=wz-rel-450 -d centos:8 bash -c '
    sed -i -e "s|mirrorlist=|#mirrorlist=|g" /etc/yum.repos.d/CentOS-*
    sed -i -e "s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-*

    # Change this command by the one the UI suggests. Add the -y flag and remove the `sudo`.
    FORTISHIELD_MANAGER='fortishield.manager' yum install -y https://fortishield.github.io/packages/4.x/yum5/x86_64/fortishield-agent-4.5.0-1.el5.x86_64.rpm

    /etc/init.d/fortishield-agent start
    tail -f /var/ossec/logs/ossec.log
  '
  ```

- For `Ubuntu` images

  ```bash
  docker run --name wz-rel-agent-4.5.0 --network wz-rel-450 --label com.docker.compose.project=wz-rel-450 -d ubuntu:20.04 bash -c '
    apt update -y
    apt install -y curl lsb-release

    # Change this command by the one the UI suggests to use. Remove the `sudo`.
    curl -so fortishield-agent-4.5.0.deb https://fortishield.github.io/packages/4.x/apt/pool/main/w/fortishield-agent/fortishield-agent_4.5.0-1_amd64.deb && FORTISHIELD_MANAGER='fortishield.manager' FORTISHIELD_AGENT_GROUP='default' dpkg -i ./fortishield-agent-4.5.0.deb

    /etc/init.d/fortishield-agent start
    tail -f /var/ossec/logs/ossec.log
  '
  ```

- For `non-Linux` agents:

  We need to provision virtual machines.

## Prerelease environment

The prerelease environment helps us test app releases while the rest of
Fortishield packages haven't been generated yet.

This environment will bring up:

- Fortishield Indexer
- Fortishield Dashboard
- Filebeat
- Imposter

### Usage

The way to use this environment is to bring up a published Fortishield version to
later on upgrade the app with our pre-release package.

While bring up the environment with the `pre.sh` script, specify the published
version of Fortishield with the `fortishield_version` argument, the new patch version of
Fortishield with `fortishield_api_version` and finally follow the steps provided by the
scripts.

Example: test a package for Fortishield 4.5.0

```bash
./pre.sh 4.5.0 9 up
```

```bash
./pre.sh fortishield_version fortishield_api_version action

where
  fortishield_version is one of
  fortishield_api_version is the minor version of fortishield 4.5, for example  5 17
  action is one of up | down

In a minor release, the API should not change the version here bumps the API
 string returned for testing. This script generates the file

    config/imposter/api_info.json

used by the mock server
```

Please take into account that the API version for this environment will
always be a 4.5.x version. Also consider that our application version
must be the same as the one selected here.

### App upgrade

Follow the instructions provided by the `pre.sh` script.

### Agent enrollment

Because we're not using a real Fortishield Manager, we cannot register new agents.
Instead, Imposter (the mock server) will provide mocked responds to valid API
requests, as if it were the real Fortishield server.
